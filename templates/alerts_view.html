{% extends 'base.html' %}
{% block title %}Alertes – {{ upload_id }}{% endblock %}

{% block content %}
  <h2 class="mb-4">Alertes opérationnelles</h2>

  <div class="card-custom p-4 mb-5">
    <form id="alertForm" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Seuil absolu (€)</label>
        <input type="number" step="0.01" class="form-control" id="abs_threshold">
      </div>
      <div class="col-md-4">
        <label class="form-label">Seuil relatif (%)</label>
        <input type="number" step="0.1" class="form-control" id="rel_threshold">
      </div>
      <div class="col-md-4 d-grid">
        <button class="btn btn-primary">Mettre à jour</button>
      </div>
    </form>
  </div>

  <div class="card-custom p-4">
    <h5 class="mb-3">Jours en alerte</h5>
    <div id="alertsList"></div>
  </div>
{% endblock %}

{% block scripts %}
<script>
const apiAlerts = "{{ url_for('api_alerts', upload_id=upload_id) }}",
      apiForecast = "{{ url_for('api_forecast', upload_id=upload_id) }}";

async function initAlerts(){
  const r = await fetch(apiAlerts);
  if(r.ok){ const c = await r.json();
    abs_threshold.value = c.abs_threshold||'';
    rel_threshold.value = c.rel_threshold||'';
  }
  updateAlerts();
}

async function saveAlerts(e){
  e.preventDefault();
  await fetch(apiAlerts,{method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      abs_threshold: parseFloat(abs_threshold.value)||null,
      rel_threshold: parseFloat(rel_threshold.value)||null,
      email_enabled:false
    })
  });
  updateAlerts();
}

async function updateAlerts(){
  const fc = await(await fetch(apiForecast)).json(),
        abs = parseFloat(abs_threshold.value)||Infinity,
        rel = parseFloat(rel_threshold.value)||Infinity;
  const list = fc.filter((pt,i)=> pt.value<abs ||
    (i>0 && ((fc[i-1].value-pt.value)/fc[i-1].value*100)>rel)
  );
  const container = document.getElementById('alertsList');
  if(!list.length){
    container.innerHTML = '<div class="alert alert-success">Aucune alerte.</div>';
    return;
  }
  container.innerHTML = `<ul class="list-group">${
    list.map(pt=>`<li class="list-group-item d-flex justify-content-between">
      <span>${pt.date}</span>
      <span>${pt.value.toFixed(2)} €</span>
    </li>`).join('')
  }</ul>`;
}

alertForm.addEventListener('submit', saveAlerts);
window.addEventListener('DOMContentLoaded', initAlerts);
</script>
{% endblock %}
