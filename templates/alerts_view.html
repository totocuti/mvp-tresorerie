{% extends 'base.html' %}
{% block title %}Alertes – {{ upload_id }}{% endblock %}

{% block content %}
  <h1 class="h3 mb-4">Alertes pour l’upload #{{ upload_id }}</h1>

  <form id="alertForm" class="row g-3 mb-5">
    <div class="col-md-4">
      <label for="abs_threshold" class="form-label">Seuil absolu (€)</label>
      <input type="number" step="0.01" class="form-control" id="abs_threshold" name="abs_threshold">
    </div>
    <div class="col-md-4">
      <label for="rel_threshold" class="form-label">Seuil relatif (%)</label>
      <input type="number" step="0.1" class="form-control" id="rel_threshold" name="rel_threshold">
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Enregistrer</button>
    </div>
  </form>

  <div id="alertsList"></div>

  <a href="{{ url_for('dashboard', upload_id=upload_id) }}" class="btn btn-link mt-4">
    ← Retour au dashboard
  </a>
{% endblock %}

{% block scripts %}
<script>
const uploadId = {{ upload_id }};
const apiAlerts = "{{ url_for('api_alerts', upload_id=upload_id) }}";
const apiForecast = "{{ url_for('api_forecast', upload_id=upload_id) }}";

async function loadSettings(){
  let r = await fetch(apiAlerts);
  if(r.ok){
    let cfg = await r.json();
    document.getElementById('abs_threshold').value = cfg.abs_threshold ?? '';
    document.getElementById('rel_threshold').value = cfg.rel_threshold ?? '';
  }
  refreshAlerts();
}
async function saveSettings(e){
  e.preventDefault();
  let body = {
    abs_threshold: parseFloat(document.getElementById('abs_threshold').value)||null,
    rel_threshold: parseFloat(document.getElementById('rel_threshold').value)||null,
    email_enabled:false
  };
  await fetch(apiAlerts,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  refreshAlerts();
}
async function refreshAlerts(){
  let fc = await (await fetch(apiForecast)).json();
  let abs = parseFloat(document.getElementById('abs_threshold').value)||Infinity;
  let rel = parseFloat(document.getElementById('rel_threshold').value)||Infinity;
  let list = fc.filter((pt,i)=> pt.value<abs || (i>0 && ((fc[i-1].value-pt.value)/fc[i-1].value*100)>rel));
  let c = document.getElementById('alertsList');
  if(!list.length){
    c.innerHTML = '<div class="alert alert-success">Aucune alerte détectée.</div>';
    return;
  }
  c.innerHTML = `<table class="table table-bordered">
    <thead><tr><th>Date</th><th>Solde prévu</th><th>Variation %</th></tr></thead>
    <tbody>${
      list.map((pt,i)=>`<tr><td>${pt.date}</td><td>${pt.value.toFixed(2)} €</td><td>${
        i>0?((fc[i-1].value-pt.value)/fc[i-1].value*100).toFixed(2)+' %':'N/A'
      }</td></tr>`).join('')
    }</tbody>
  </table>`;
}

document.getElementById('alertForm').addEventListener('submit', saveSettings);
window.addEventListener('DOMContentLoaded', loadSettings);
</script>
{% endblock %}
